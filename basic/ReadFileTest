package basic;

import org.apache.commons.io.FileUtils;
import org.apache.commons.io.IOUtils;
import org.junit.Assert;
import org.junit.Test;

import java.io.*;
import java.net.URL;
import java.net.URLConnection;
import java.nio.ByteBuffer;
import java.nio.channels.FileChannel;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.Scanner;

import static org.hamcrest.CoreMatchers.containsString;
import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertTrue;

public class ReadFileTest {


    private String readFromInputStream(InputStream inputStream)
            throws IOException {
        StringBuilder resultStringBuilder = new StringBuilder();
        try (BufferedReader br
                     = new BufferedReader(new InputStreamReader(inputStream))) {
            String line;
            while ((line = br.readLine()) != null) {
                resultStringBuilder.append(line).append("\n");
            }
        }
        return resultStringBuilder.toString();
    }

    @Test
    public void test() throws IOException {
        String expectedData = "Hello,World!";
        Class<ReadFileTest> clazz = ReadFileTest.class;
        InputStream inputStream = clazz.getResourceAsStream("fileTest.txt");
        String data = readFromInputStream(inputStream);

        Assert.assertThat(data, containsString(expectedData));

    }

    @Test
    public void test2() throws IOException {
        ClassLoader classLoader = getClass().getClassLoader();
        InputStream inputStream = classLoader.getResourceAsStream("fileTest.txt");
        String data = readFromInputStream(inputStream);

        String expectedData = "Hello,World!";
        Assert.assertThat(data, containsString(expectedData));
    }

    @Test
    public void useCommonIO() throws IOException {
        String expectedData = "Hello,World!";

        ClassLoader classLoader = getClass().getClassLoader();
        File file = new File(classLoader.getResource("fileTest.txt").getFile());
        String data = FileUtils.readFileToString(file, "UTF-8");

        assertEquals(expectedData, data.trim());
    }

    @Test
    public void useCommonIO2() throws IOException {
        String expectedData = "Hello,World!";

        FileInputStream fis = new FileInputStream("src/test/resources/fileTest.txt");
        String data = IOUtils.toString(fis, "UTF-8");

        assertEquals(expectedData, data.trim());
    }

    @Test
    public void bufferedReader()
            throws IOException {
        String expected_value = "Hello,World!";
        String file = "src/test/resources/fileTest.txt";

        BufferedReader reader = new BufferedReader(new FileReader(file));
        String currentLine = reader.readLine();
        reader.close();

        assertEquals(expected_value, currentLine);
    }

    @Test
    public void readSmallFile() throws IOException {
        String expected_value = "Hello,World!";

        Path path = Paths.get("src/test/resources/fileTest.txt");

        String read = Files.readAllLines(path).get(0);
        assertEquals(expected_value, read);
    }

    @Test
    public void readLargeFile() throws IOException {
        String expected_value = "Hello,World!";

        Path path = Paths.get("src/test/resources/fileTest.txt");

        BufferedReader reader = Files.newBufferedReader(path);
        String line = reader.readLine();
        assertEquals(expected_value, line);
    }

    @Test
    public void whenReadWithScanner_thenCorrect()
            throws IOException {
        String file = "src/test/resources/fileTest.txt";
        Scanner scanner = new Scanner(new File(file));
        scanner.useDelimiter(",");

        assertTrue(scanner.hasNext());
        assertEquals("Hello", scanner.next());
        assertEquals("World!", scanner.next());

        scanner.close();
    }

    @Test
    public void readWithTokenize()
            throws IOException {
        String file = "src/test/resources/fileTestTokenizer.txt";
        FileReader reader = new FileReader(file);
        StreamTokenizer tokenizer = new StreamTokenizer(reader);

        //  1
        tokenizer.nextToken();
        assertEquals(StreamTokenizer.TT_WORD, tokenizer.ttype);
        assertEquals("Hello", tokenizer.sval);

        //  2
        tokenizer.nextToken();
        assertEquals(StreamTokenizer.TT_NUMBER, tokenizer.ttype);
        assertEquals(1, tokenizer.nval, 0.0000001);

        //  3
        tokenizer.nextToken();
        assertEquals(StreamTokenizer.TT_EOF, tokenizer.ttype);
        reader.close();
    }

    @Test
    public void whenReadWithDataInputStream() throws IOException {
        String expectedValue = "Hello,World!";
        String file ="src/test/resources/fileTest.txt";
        String result = null;

        DataInputStream reader = new DataInputStream(new FileInputStream(file));
        int nBytesToRead = reader.available();
        if(nBytesToRead > 0) {
            byte[] bytes = new byte[nBytesToRead];
            reader.read(bytes);
            result = new String(bytes);
        }

        assertEquals(expectedValue, result);
    }

    @Test
    public void whenReadWithFileChannel()
            throws IOException {
        String expected_value = "Hello,World!";
        String file = "src/test/resources/fileTest.txt";
        RandomAccessFile reader = new RandomAccessFile(file, "r");
        FileChannel channel = reader.getChannel();

        int bufferSize = 1024;
        if (bufferSize > channel.size()) {
            bufferSize = (int) channel.size();
        }
        ByteBuffer buff = ByteBuffer.allocate(bufferSize);
        channel.read(buff);
        buff.flip();

        assertEquals(expected_value, new String(buff.array()));
        channel.close();
        reader.close();
    }

    @Test
    public void whenReadUTFEncodedFile()
            throws IOException {
        String expected_value = "你好，世界！";
        String file = "src/test/resources/fileTestUtf8.txt";
        BufferedReader reader = new BufferedReader
                (new InputStreamReader(new FileInputStream(file), "UTF-8"));
        String currentLine = reader.readLine();
        reader.close();

        assertEquals(expected_value, currentLine);
    }

    @Test
    public void readFromURL() throws IOException {
        URL urlObject = new URL("https://www.baidu.com");
        URLConnection urlConnection = urlObject.openConnection();
        InputStream inputStream = urlConnection.getInputStream();
        String data = readFromInputStream(inputStream);
    }

    @Test
    public void readFromJar() throws IOException {
        String expectedData = "Eclipse Public License";

        Class clazz = Test.class;
        InputStream inputStream = clazz.getResourceAsStream("/LICENSE-junit.txt");
        String data = readFromInputStream(inputStream);

        Assert.assertThat(data, containsString(expectedData));
    }
}
